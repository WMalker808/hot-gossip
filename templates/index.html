<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Comment Analyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "Guardian Text Sans Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: #dcdcdc;
            color: #121212;
            line-height: 1.5;
        }

        h1, h2, h3, h4, .meta-title, .theme-header h4, .followup-header h4 {
            font-family: "Guardian Egyptian Web", Georgia, serif;
        }

        header {
            background: #052962;
            color: white;
            padding: 0.6rem 1rem 0;
        }
        header h1 {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.15;
            max-width: 820px;
            margin: 0 auto;
            padding-bottom: 0.5rem;
        }
        header p {
            font-size: 0.9rem;
            max-width: 820px;
            margin: 0 auto;
            padding-bottom: 0.6rem;
            opacity: 0.85;
            font-family: "Guardian Text Sans Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        .yellow-band {
            height: 4px;
            background: #FFE500;
        }

        main {
            max-width: 820px;
            margin: 0 auto;
            padding: 1.25rem 1rem 2rem;
        }

        /* Form */
        #analyze-form {
            display: flex;
            gap: 0;
            margin-bottom: 1.25rem;
            border: 1px solid #999;
        }
        #url-input {
            flex: 1;
            padding: 0.7rem 0.75rem;
            font-size: 1rem;
            border: none;
            outline: none;
            background: white;
            font-family: "Guardian Text Sans Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        #submit-btn {
            padding: 0.7rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            background: #c70000;
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: "Guardian Text Sans Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
            transition: background 0.15s;
        }
        #submit-btn:hover { background: #ab0000; }
        #submit-btn:disabled { background: #999; cursor: not-allowed; }

        /* Progress */
        #progress-section {
            margin-bottom: 1.25rem;
            padding: 1rem;
            background: #FFF4B8;
            border-top: 2px solid #FFE500;
        }
        #progress-bar-container {
            width: 100%;
            height: 4px;
            background: #e0d68a;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        #progress-bar {
            height: 100%;
            background: #052962;
            transition: width 0.5s ease;
            width: 0%;
        }
        #progress-message {
            font-size: 0.85rem;
            color: #333;
        }

        /* Error */
        #error-section {
            background: #fff4f2;
            border-top: 2px solid #c70000;
            padding: 1rem;
            margin-bottom: 1.25rem;
            color: #c70000;
            font-size: 0.9rem;
        }

        /* Result cards */
        .result-card {
            background: white;
            padding: 1rem 1rem 1.25rem;
            margin-bottom: 0;
            border-top: 1px solid #052962;
        }
        .result-card + .result-card {
            border-top: 1px solid #dcdcdc;
        }
        .result-card:first-child {
            border-top: 4px solid #052962;
        }
        .result-card h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #052962;
            margin-bottom: 0.75rem;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid #dcdcdc;
        }

        /* Meta */
        .meta-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.6rem;
            line-height: 1.25;
        }
        .meta-title a { color: #052962; text-decoration: none; }
        .meta-title a:hover { text-decoration: underline; color: #c70000; }
        .meta-stats { display: flex; gap: 1rem; flex-wrap: wrap; }
        .stat {
            font-size: 0.8rem;
            color: #707070;
            background: #f6f6f6;
            padding: 0.2rem 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* Sentiment */
        .sentiment-bar {
            display: flex;
            height: 36px;
            overflow: hidden;
            margin: 0.5rem 0 0.75rem;
        }
        .bar-positive { background: #22874D; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; }
        .bar-neutral  { background: #707070; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; }
        .bar-negative { background: #c70000; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; }
        .sentiment-legend {
            display: flex;
            gap: 1.25rem;
            font-size: 0.8rem;
            margin-bottom: 0.75rem;
            color: #707070;
        }
        .legend-positive::before { content: ""; display: inline-block; width: 10px; height: 10px; background: #22874D; margin-right: 4px; vertical-align: middle; }
        .legend-neutral::before  { content: ""; display: inline-block; width: 10px; height: 10px; background: #707070; margin-right: 4px; vertical-align: middle; }
        .legend-negative::before { content: ""; display: inline-block; width: 10px; height: 10px; background: #c70000; margin-right: 4px; vertical-align: middle; }
        #sentiment-summary {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        #sentiment-topics h4 {
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
            color: #052962;
            font-weight: 700;
        }
        .topic-row {
            padding: 0.4rem 0;
            border-bottom: 1px dotted #dcdcdc;
        }
        .topic-row:last-child { border-bottom: none; }
        .topic-name { font-weight: 700; margin-right: 0.4rem; font-size: 0.9rem; }
        .topic-pct { color: #707070; font-size: 0.8rem; margin-left: 0.4rem; }
        .topic-explanation { font-size: 0.85rem; color: #555; margin-top: 0.2rem; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 1px 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            border: 1px solid;
        }
        .badge-high     { border-color: #22874D; color: #22874D; background: transparent; }
        .badge-medium   { border-color: #e05e00; color: #e05e00; background: transparent; }
        .badge-low      { border-color: #707070; color: #707070; background: transparent; }
        .badge-positive { border-color: #22874D; color: #22874D; background: transparent; }
        .badge-negative { border-color: #c70000; color: #c70000; background: transparent; }
        .badge-mixed    { border-color: #e05e00; color: #e05e00; background: transparent; }
        .badge-neutral  { border-color: #707070; color: #707070; background: transparent; }

        /* Follow-up ideas */
        .followup-item {
            padding: 0.75rem 0;
            border-bottom: 1px dotted #dcdcdc;
        }
        .followup-item:last-child { border-bottom: none; }
        .followup-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.35rem;
            flex-wrap: wrap;
        }
        .followup-rank {
            width: 22px;
            height: 22px;
            background: #FFE500;
            color: #121212;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .followup-header h4 { font-size: 1rem; margin: 0; font-weight: 700; }
        .followup-angle { font-size: 0.9rem; color: #333; margin-bottom: 0.2rem; }
        .followup-evidence { font-size: 0.85rem; color: #555; margin-bottom: 0.4rem; }
        .suggested-sources { font-size: 0.85rem; margin-top: 0.2rem; }
        .source-tag {
            display: inline-block;
            background: transparent;
            color: #c70000;
            padding: 1px 6px;
            border: 1px solid #c70000;
            font-size: 0.75rem;
            margin: 2px;
            font-weight: 700;
        }

        /* Discussion questions */
        .questions-intro {
            font-size: 0.9rem;
            color: #707070;
            margin-bottom: 0.75rem;
            font-style: italic;
        }
        .question-item {
            padding: 0.75rem 0;
            border-bottom: 1px dotted #dcdcdc;
        }
        .question-item:last-child { border-bottom: none; }
        .question-header {
            display: flex;
            align-items: flex-start;
            gap: 0.4rem;
            margin-bottom: 0.35rem;
        }
        .question-rank {
            width: 22px;
            height: 22px;
            background: #FFE500;
            color: #121212;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .question-text {
            font-family: "Guardian Egyptian Web", Georgia, serif;
            font-size: 1.05rem;
            font-weight: 700;
            color: #121212;
            line-height: 1.3;
        }
        .question-intent {
            font-size: 0.85rem;
            color: #555;
            margin: 0.25rem 0 0.4rem 26px;
        }
        .question-perspectives {
            margin-left: 26px;
        }
        .perspective-tag {
            display: inline-block;
            background: transparent;
            color: #052962;
            padding: 1px 6px;
            border: 1px solid #052962;
            font-size: 0.75rem;
            margin: 2px;
            font-weight: 700;
        }

        .hidden { display: none; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            background: white;
            border-bottom: 3px solid #052962;
        }
        .tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            background: #f6f6f6;
            color: #707070;
            border: none;
            border-right: 1px solid #dcdcdc;
            transition: background 0.15s, color 0.15s;
        }
        .tab:last-child { border-right: none; }
        .tab:hover { background: #e8e8e8; color: #333; }
        .tab.active {
            background: #052962;
            color: white;
        }

        /* Tab panels */
        .tab-panel {
            background: white;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            border: 1px solid #dcdcdc;
            border-top: none;
        }
        .tab-panel.hidden { display: none; }

        .panel-description {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .panel-description strong {
            color: #052962;
        }

        /* Search forms */
        .search-form {
            display: flex;
            gap: 0;
            border: 1px solid #999;
        }
        .form-input {
            flex: 1;
            padding: 0.75rem;
            font-size: 1rem;
            border: none;
            outline: none;
            background: white;
            font-family: "Guardian Text Sans Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        .form-input:focus {
            box-shadow: inset 0 0 0 2px #FFE500;
        }
        .input-group {
            flex: 1;
            display: flex;
            background: white;
        }
        .limit-wrapper {
            display: flex;
            align-items: center;
            padding: 0 0.75rem;
            border-left: 1px solid #dcdcdc;
            background: #f6f6f6;
            gap: 0.4rem;
        }
        .limit-wrapper label {
            font-size: 0.8rem;
            color: #707070;
            white-space: nowrap;
        }
        .limit-input {
            width: 50px;
            padding: 0.3rem;
            font-size: 0.9rem;
            border: 1px solid #dcdcdc;
            text-align: center;
        }
        .submit-btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            background: #c70000;
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: "Guardian Text Sans Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
            transition: background 0.15s;
        }
        .submit-btn:hover { background: #ab0000; }
        .submit-btn:disabled { background: #999; cursor: not-allowed; }

        /* Articles list */
        .articles-list {
            margin-top: 0.5rem;
        }
        .article-item {
            padding: 0.5rem 0;
            border-bottom: 1px dotted #dcdcdc;
            font-size: 0.9rem;
        }
        .article-item:last-child { border-bottom: none; }
        .article-item a {
            color: #052962;
            text-decoration: none;
        }
        .article-item a:hover {
            color: #c70000;
            text-decoration: underline;
        }
        .article-comment-count {
            color: #707070;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        @media (max-width: 600px) {
            .tabs { flex-direction: column; border-bottom: none; }
            .tab { border-right: none; border-bottom: 1px solid #dcdcdc; }
            .tab.active { border-bottom-color: #052962; }
            .search-form { flex-direction: column; }
            .input-group { flex-direction: column; }
            .limit-wrapper { border-left: none; border-top: 1px solid #dcdcdc; justify-content: center; padding: 0.5rem; }
            .meta-stats { flex-direction: column; gap: 0.5rem; }
            .sentiment-legend { flex-direction: column; gap: 0.25rem; }
            header h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Hot Gossip! Guardian comments analyser</h1>
        <p>Analyze article comments or search by keyword</p>
    </header>
    <div class="yellow-band"></div>

    <main>
        <div class="tabs">
            <button type="button" class="tab active" data-tab="article">Single Article</button>
            <button type="button" class="tab" data-tab="section">Section / Front</button>
            <button type="button" class="tab" data-tab="keyword">Keyword Search</button>
        </div>

        <div id="panel-article" class="tab-panel">
            <p class="panel-description">
                <strong>Analyze a single article.</strong>
                Paste the full URL of any Guardian article to analyze its comments for sentiment, themes, and commercial opportunities.
            </p>
            <form id="analyze-form" class="search-form">
                <input type="url" id="url-input" class="form-input" placeholder="https://www.theguardian.com/..." required>
                <button type="submit" id="submit-btn" class="submit-btn">Analyze</button>
            </form>
        </div>

        <div id="panel-section" class="tab-panel hidden">
            <p class="panel-description">
                <strong>Analyze a section or front page.</strong>
                Paste a Guardian section URL to extract articles and analyze comments across multiple pieces. Great for tracking brand mentions across a topic area.
            </p>
            <form id="section-form" class="search-form">
                <div class="input-group">
                    <input type="url" id="section-input" class="form-input" placeholder="https://www.theguardian.com/lifeandstyle/health-and-wellbeing" required>
                    <div class="limit-wrapper">
                        <label for="section-limit-input">Articles:</label>
                        <input type="number" id="section-limit-input" class="limit-input" min="1" max="20" value="10">
                    </div>
                </div>
                <button type="submit" id="section-submit-btn" class="submit-btn">Analyze</button>
            </form>
        </div>

        <div id="panel-keyword" class="tab-panel hidden">
            <p class="panel-description">
                <strong>Search by keyword.</strong>
                Search for Guardian articles matching a keyword and analyze comments across all results. Requires a Guardian API key.
            </p>
            <form id="keyword-form" class="search-form">
                <div class="input-group">
                    <input type="text" id="keyword-input" class="form-input" placeholder="Enter keyword (e.g. electric cars)" required>
                    <div class="limit-wrapper">
                        <label for="limit-input">Articles:</label>
                        <input type="number" id="limit-input" class="limit-input" min="1" max="20" value="10">
                    </div>
                </div>
                <button type="submit" id="keyword-submit-btn" class="submit-btn">Search</button>
            </form>
        </div>

        <div id="progress-section" class="hidden">
            <div id="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
            <p id="progress-message">Starting...</p>
        </div>

        <div id="error-section" class="hidden">
            <p id="error-message"></p>
        </div>

        <div id="results-section" class="hidden">
            <div id="meta-card" class="result-card hidden">
                <h2>Article Info</h2>
                <div id="meta-content"></div>
            </div>

            <div id="keyword-meta-card" class="result-card hidden">
                <h2>Keyword Search Results</h2>
                <div id="keyword-meta-content"></div>
            </div>

            <div id="articles-card" class="result-card hidden">
                <h2>Articles Analyzed</h2>
                <div id="articles-content" class="articles-list"></div>
            </div>

            <div id="questions-card" class="result-card hidden">
                <h2>Discussion Questions</h2>
                <p class="questions-intro">Three questions to promote constructive, diverse debate:</p>
                <div id="questions-content"></div>
            </div>

            <div id="sentiment-card" class="result-card hidden">
                <h2>Sentiment Analysis</h2>
                <div id="sentiment-chart"></div>
                <p id="sentiment-summary"></p>
                <div id="sentiment-topics"></div>
            </div>

            <div id="commercial-card" class="result-card hidden">
                <h2>Commercial Opportunities</h2>
                <div id="commercial-content"></div>
            </div>
        </div>
    </main>

    <script>
        const form = document.getElementById("analyze-form");
        const urlInput = document.getElementById("url-input");
        const submitBtn = document.getElementById("submit-btn");
        const sectionForm = document.getElementById("section-form");
        const sectionInput = document.getElementById("section-input");
        const sectionLimitInput = document.getElementById("section-limit-input");
        const sectionSubmitBtn = document.getElementById("section-submit-btn");
        const keywordForm = document.getElementById("keyword-form");
        const keywordInput = document.getElementById("keyword-input");
        const limitInput = document.getElementById("limit-input");
        const keywordSubmitBtn = document.getElementById("keyword-submit-btn");
        const progressSection = document.getElementById("progress-section");
        const progressMessage = document.getElementById("progress-message");
        const progressBar = document.getElementById("progress-bar");
        const errorSection = document.getElementById("error-section");
        const errorMessage = document.getElementById("error-message");
        const resultsSection = document.getElementById("results-section");
        const tabs = document.querySelectorAll(".tab");
        const panels = {
            article: document.getElementById("panel-article"),
            section: document.getElementById("panel-section"),
            keyword: document.getElementById("panel-keyword")
        };

        let eventSource = null;
        let currentProgress = 0;
        let currentMode = "article";

        function show(el) { el.classList.remove("hidden"); }
        function hide(el) { el.classList.add("hidden"); }

        function escapeHtml(str) {
            const div = document.createElement("div");
            div.textContent = str;
            return div.innerHTML;
        }

        // Tab click handler
        tabs.forEach(function(tab) {
            tab.addEventListener("click", function() {
                var targetTab = this.dataset.tab;
                currentMode = targetTab;

                // Update tab styles
                tabs.forEach(function(t) { t.classList.remove("active"); });
                this.classList.add("active");

                // Show/hide panels
                Object.keys(panels).forEach(function(key) {
                    if (key === targetTab) {
                        show(panels[key]);
                    } else {
                        hide(panels[key]);
                    }
                });

                resetResults();
            });
        });

        function resetResults() {
            currentProgress = 0;
            progressBar.style.width = "0%";
            progressMessage.textContent = "Starting...";
            document.getElementById("meta-content").innerHTML = "";
            document.getElementById("keyword-meta-content").innerHTML = "";
            document.getElementById("articles-content").innerHTML = "";
            document.getElementById("sentiment-chart").innerHTML = "";
            document.getElementById("sentiment-summary").textContent = "";
            document.getElementById("sentiment-topics").innerHTML = "";
            document.getElementById("questions-content").innerHTML = "";
            document.getElementById("commercial-content").innerHTML = "";
            ["meta-card", "keyword-meta-card", "articles-card", "sentiment-card", "questions-card", "commercial-card"].forEach(function(id) {
                hide(document.getElementById(id));
            });
            hide(resultsSection);
            hide(errorSection);
        }

        form.addEventListener("submit", function(e) {
            e.preventDefault();
            var url = urlInput.value.trim();
            if (!url) return;

            resetResults();
            show(progressSection);
            submitBtn.disabled = true;
            submitBtn.textContent = "Analyzing...";

            if (eventSource) eventSource.close();

            eventSource = new EventSource("/analyze?url=" + encodeURIComponent(url));

            eventSource.onmessage = function(event) {
                try {
                    var data = JSON.parse(event.data);
                    switch (data.type) {
                        case "progress": handleProgress(data); break;
                        case "result":   handleResult(data);   break;
                        case "complete": handleComplete();      break;
                        case "error":    handleError(data.message); break;
                    }
                } catch (e) {
                    console.error("SSE parse/render error:", e);
                }
            };

            eventSource.onerror = function() {
                eventSource.close();
                if (submitBtn.disabled) {
                    handleError("Connection lost. Please try again.");
                }
            };
        });

        keywordForm.addEventListener("submit", function(e) {
            e.preventDefault();
            var keyword = keywordInput.value.trim();
            if (!keyword) return;

            var limit = parseInt(limitInput.value) || 10;
            limit = Math.max(1, Math.min(limit, 20));

            resetResults();
            show(progressSection);
            keywordSubmitBtn.disabled = true;
            keywordSubmitBtn.textContent = "Searching...";

            if (eventSource) eventSource.close();

            eventSource = new EventSource("/analyze-keyword?keyword=" + encodeURIComponent(keyword) + "&limit=" + limit);

            eventSource.onmessage = function(event) {
                try {
                    var data = JSON.parse(event.data);
                    switch (data.type) {
                        case "progress": handleKeywordProgress(data); break;
                        case "result":   handleKeywordResult(data);   break;
                        case "complete": handleKeywordComplete();      break;
                        case "error":    handleError(data.message); break;
                    }
                } catch (e) {
                    console.error("SSE parse/render error:", e);
                }
            };

            eventSource.onerror = function() {
                eventSource.close();
                if (keywordSubmitBtn.disabled) {
                    handleError("Connection lost. Please try again.");
                }
            };
        });

        sectionForm.addEventListener("submit", function(e) {
            e.preventDefault();
            var url = sectionInput.value.trim();
            if (!url) return;

            var limit = parseInt(sectionLimitInput.value) || 10;
            limit = Math.max(1, Math.min(limit, 20));

            resetResults();
            show(progressSection);
            sectionSubmitBtn.disabled = true;
            sectionSubmitBtn.textContent = "Analyzing...";

            if (eventSource) eventSource.close();

            eventSource = new EventSource("/analyze-section?url=" + encodeURIComponent(url) + "&limit=" + limit);

            eventSource.onmessage = function(event) {
                try {
                    var data = JSON.parse(event.data);
                    switch (data.type) {
                        case "progress": handleSectionProgress(data); break;
                        case "result":   handleSectionResult(data);   break;
                        case "complete": handleSectionComplete();      break;
                        case "error":    handleError(data.message); break;
                    }
                } catch (e) {
                    console.error("SSE parse/render error:", e);
                }
            };

            eventSource.onerror = function() {
                eventSource.close();
                if (sectionSubmitBtn.disabled) {
                    handleError("Connection lost. Please try again.");
                }
            };
        });

        function handleProgress(data) {
            progressMessage.textContent = data.message;
            var msg = data.message.toLowerCase();
            if (msg.includes("discussion"))       currentProgress = 30;
            else if (msg.includes("sentiment"))   currentProgress = 55;
            else if (msg.includes("commercial"))  currentProgress = 80;
            else if (msg.includes("scraped"))     currentProgress = 15;
            else if (msg.includes("preparing"))   currentProgress = 20;
            else currentProgress = Math.min(currentProgress + 3, 15);
            progressBar.style.width = currentProgress + "%";
        }

        function handleResult(data) {
            show(resultsSection);
            switch (data.section) {
                case "meta":         renderMeta(data.data);     break;
                case "sentiment":    renderSentiment(data.data); break;
                case "discussionQuestions": renderDiscussionQuestions(data.data); break;
                case "commercialOpportunities": renderCommercial(data.data); break;
            }
        }

        function handleComplete() {
            if (eventSource) eventSource.close();
            progressBar.style.width = "100%";
            progressMessage.textContent = "Analysis complete!";
            submitBtn.disabled = false;
            submitBtn.textContent = "Analyze";
            setTimeout(function() { hide(progressSection); }, 1500);

            // Ensure commercial card is visible even if its SSE event was missed
            var commercialCard = document.getElementById("commercial-card");
            if (commercialCard.classList.contains("hidden")) {
                show(commercialCard);
                document.getElementById("commercial-content").innerHTML =
                    '<p style="color:#707070;">No commercial signals found in comments.</p>';
            }
        }

        function handleKeywordProgress(data) {
            progressMessage.textContent = data.message;
            var msg = data.message.toLowerCase();
            if (msg.includes("searching"))        currentProgress = 10;
            else if (msg.includes("found"))       currentProgress = 20;
            else if (msg.includes("scraping"))    currentProgress = 30 + (parseInt(msg.match(/\d+/) || [0])[0] * 4);
            else if (msg.includes("preparing"))   currentProgress = 70;
            else if (msg.includes("extracting"))  currentProgress = 80;
            else currentProgress = Math.min(currentProgress + 5, 90);
            progressBar.style.width = Math.min(currentProgress, 95) + "%";
        }

        function handleKeywordResult(data) {
            show(resultsSection);
            switch (data.section) {
                case "articles":    renderArticles(data.data);      break;
                case "meta":        renderKeywordMeta(data.data);   break;
                case "commercialOpportunities": renderCommercial(data.data); break;
            }
        }

        function handleKeywordComplete() {
            if (eventSource) eventSource.close();
            progressBar.style.width = "100%";
            progressMessage.textContent = "Analysis complete!";
            keywordSubmitBtn.disabled = false;
            keywordSubmitBtn.textContent = "Search";
            setTimeout(function() { hide(progressSection); }, 1500);

            // Ensure commercial card is visible
            var commercialCard = document.getElementById("commercial-card");
            if (commercialCard.classList.contains("hidden")) {
                show(commercialCard);
                document.getElementById("commercial-content").innerHTML =
                    '<p style="color:#707070;">No commercial signals found in comments.</p>';
            }
        }

        function renderArticles(articles) {
            var card = document.getElementById("articles-card");
            show(card);
            document.getElementById("articles-content").innerHTML = articles.map(function(a) {
                return '<div class="article-item">' +
                    '<a href="' + escapeHtml(a.url) + '" target="_blank">' + escapeHtml(a.title) + '</a>' +
                    (a.section ? '<span class="article-comment-count">' + escapeHtml(a.section) + '</span>' : '') +
                '</div>';
            }).join("");
        }

        function renderKeywordMeta(data) {
            var card = document.getElementById("keyword-meta-card");
            show(card);
            document.getElementById("keyword-meta-content").innerHTML =
                '<h3 class="meta-title">Keyword: "' + escapeHtml(data.keyword) + '"</h3>' +
                '<div class="meta-stats">' +
                    '<span class="stat">' + data.articlesSearched + ' articles searched</span>' +
                    '<span class="stat">' + data.articlesWithComments + ' with comments</span>' +
                    '<span class="stat">' + data.totalComments + ' total comments</span>' +
                    '<span class="stat">' + data.commentsAnalyzed + ' analyzed</span>' +
                '</div>';
        }

        function handleSectionProgress(data) {
            progressMessage.textContent = data.message;
            var msg = data.message.toLowerCase();
            if (msg.includes("extracting"))       currentProgress = 10;
            else if (msg.includes("found"))       currentProgress = 20;
            else if (msg.includes("scraping"))    currentProgress = 30 + (parseInt(msg.match(/\d+/) || [0])[0] * 3);
            else if (msg.includes("analyzing"))   currentProgress = 70;
            else if (msg.includes("processing"))  currentProgress = 80;
            else currentProgress = Math.min(currentProgress + 5, 90);
            progressBar.style.width = Math.min(currentProgress, 95) + "%";
        }

        function handleSectionResult(data) {
            show(resultsSection);
            switch (data.section) {
                case "articles":    renderArticles(data.data);      break;
                case "meta":        renderSectionMeta(data.data);   break;
                case "commercialOpportunities": renderCommercial(data.data); break;
            }
        }

        function handleSectionComplete() {
            if (eventSource) eventSource.close();
            progressBar.style.width = "100%";
            progressMessage.textContent = "Analysis complete!";
            sectionSubmitBtn.disabled = false;
            sectionSubmitBtn.textContent = "Analyze";
            setTimeout(function() { hide(progressSection); }, 1500);

            var commercialCard = document.getElementById("commercial-card");
            if (commercialCard.classList.contains("hidden")) {
                show(commercialCard);
                document.getElementById("commercial-content").innerHTML =
                    '<p style="color:#707070;">No commercial signals found in comments.</p>';
            }
        }

        function renderSectionMeta(data) {
            var card = document.getElementById("keyword-meta-card");
            show(card);
            document.getElementById("keyword-meta-content").innerHTML =
                '<h3 class="meta-title">Section: ' + escapeHtml(data.sectionName) + '</h3>' +
                '<div class="meta-stats">' +
                    '<span class="stat">' + data.articlesFound + ' articles found</span>' +
                    '<span class="stat">' + data.articlesWithComments + ' with comments</span>' +
                    '<span class="stat">' + data.totalComments + ' total comments</span>' +
                    '<span class="stat">' + data.commentsAnalyzed + ' analyzed</span>' +
                '</div>';
        }

        function handleError(msg) {
            if (eventSource) eventSource.close();
            hide(progressSection);
            show(errorSection);
            errorMessage.textContent = msg;
            // Reset all buttons
            submitBtn.disabled = false;
            submitBtn.textContent = "Analyze";
            sectionSubmitBtn.disabled = false;
            sectionSubmitBtn.textContent = "Analyze";
            keywordSubmitBtn.disabled = false;
            keywordSubmitBtn.textContent = "Search";
        }

        /* ---- Render functions ---- */

        function renderMeta(data) {
            var card = document.getElementById("meta-card");
            show(card);
            document.getElementById("meta-content").innerHTML =
                '<h3 class="meta-title"><a href="' + escapeHtml(data.articleUrl) + '" target="_blank">' + escapeHtml(data.articleTitle) + '</a></h3>' +
                '<div class="meta-stats">' +
                    '<span class="stat">' + data.totalComments + ' comments</span>' +
                    '<span class="stat">' + data.uniqueCommenters + ' unique commenters</span>' +
                    '<span class="stat">' + data.commentsAnalyzed + ' analyzed</span>' +
                '</div>';
        }

        function renderSentiment(data) {
            var card = document.getElementById("sentiment-card");
            show(card);

            var overall = data.overall || {};
            var pos = overall.positive || 0;
            var neu = overall.neutral || 0;
            var neg = overall.negative || 0;

            document.getElementById("sentiment-chart").innerHTML =
                '<div class="sentiment-bar">' +
                    '<div class="bar-positive" style="width:' + pos + '%" title="Positive: ' + pos + '%">' + (pos > 8 ? pos + "%" : "") + '</div>' +
                    '<div class="bar-neutral" style="width:' + neu + '%" title="Neutral: ' + neu + '%">' + (neu > 8 ? neu + "%" : "") + '</div>' +
                    '<div class="bar-negative" style="width:' + neg + '%" title="Negative: ' + neg + '%">' + (neg > 8 ? neg + "%" : "") + '</div>' +
                '</div>' +
                '<div class="sentiment-legend">' +
                    '<span class="legend-positive">Positive ' + pos + '%</span>' +
                    '<span class="legend-neutral">Neutral ' + neu + '%</span>' +
                    '<span class="legend-negative">Negative ' + neg + '%</span>' +
                '</div>';

            document.getElementById("sentiment-summary").textContent = overall.summary || "";

            var topics = data.byTopic || [];
            if (topics.length) {
                document.getElementById("sentiment-topics").innerHTML =
                    '<h4>By Topic</h4>' +
                    topics.map(function(t) {
                        return '<div class="topic-row">' +
                            '<span class="topic-name">' + escapeHtml(t.topic) + '</span>' +
                            '<span class="badge badge-' + t.sentiment + '">' + t.sentiment + '</span>' +
                            '<span class="topic-pct">' + t.percentage + '% of comments</span>' +
                            (t.explanation ? '<p class="topic-explanation">' + escapeHtml(t.explanation) + '</p>' : '') +
                        '</div>';
                    }).join("");
            }
        }

        function renderDiscussionQuestions(questions) {
            var card = document.getElementById("questions-card");
            show(card);

            document.getElementById("questions-content").innerHTML = questions.map(function(q) {
                return '<div class="question-item">' +
                    '<p class="question-text">' + escapeHtml(q.question) + '</p>' +
                    '<p class="question-intent" style="margin-left:0;">' + escapeHtml(q.intent) + '</p>' +
                '</div>';
            }).join("");
        }

        function renderCommercial(data) {
            var card = document.getElementById("commercial-card");
            show(card);

            if (!data || data.error) {
                document.getElementById("commercial-content").innerHTML =
                    '<p style="color:#707070;">No commercial signals found in comments.</p>';
                return;
            }

            var html = "";

            try {
                var brands = data.brands || [];
                if (brands.length) {
                    html += '<h4 style="font-size:0.95rem;color:#052962;margin-bottom:0.4rem;">Brands &amp; Products Mentioned</h4>';
                    html += brands.map(function(b) {
                        return '<div class="topic-row">' +
                            '<span class="topic-name">' + escapeHtml(b.name || "") + '</span>' +
                            '<span class="badge badge-' + (b.sentiment || "neutral") + '">' + (b.sentiment || "neutral") + '</span>' +
                            '<span class="topic-pct">' + (b.mentions || 0) + ' mention' + (b.mentions !== 1 ? 's' : '') + '</span>' +
                            '<span style="font-size:0.8rem;color:#707070;margin-left:0.4rem;">' + escapeHtml(b.category || "") + '</span>' +
                        '</div>';
                    }).join("");
                }

                var recs = data.recommendations || [];
                if (recs.length) {
                    html += '<h4 style="font-size:0.95rem;color:#052962;margin:0.75rem 0 0.4rem;">Reader Recommendations</h4>';
                    html += recs.map(function(r) {
                        return '<div class="topic-row">' +
                            '<span class="topic-name">' + escapeHtml(r.item || "") + '</span>' +
                            '<span style="font-size:0.8rem;color:#707070;margin-left:0.4rem;">' + escapeHtml(r.category || "") + '</span>' +
                            (r.quote ? '<p style="font-size:0.85rem;color:#555;margin-top:0.2rem;font-style:italic;">"' + escapeHtml(r.quote) + '"</p>' : '') +
                        '</div>';
                    }).join("");
                }

                var opps = data.opportunities || [];
                if (opps.length) {
                    html += '<h4 style="font-size:0.95rem;color:#052962;margin:0.75rem 0 0.4rem;">Opportunities</h4>';
                    html += opps.map(function(o, i) {
                        return '<div class="followup-item">' +
                            '<div class="followup-header">' +
                                '<span class="followup-rank">' + (i + 1) + '</span>' +
                                '<h4>' + escapeHtml(o.target || "") + '</h4>' +
                                '<span class="badge badge-medium">' + escapeHtml(o.type || "") + '</span>' +
                            '</div>' +
                            '<p style="font-size:0.9rem;color:#333;">' + escapeHtml(o.rationale || "") + '</p>' +
                        '</div>';
                    }).join("");
                }
            } catch (e) {
                html = "";
            }

            if (!html) html = '<p style="color:#707070;">No commercial signals found in comments.</p>';
            document.getElementById("commercial-content").innerHTML = html;
        }
    </script>
</body>
</html>
